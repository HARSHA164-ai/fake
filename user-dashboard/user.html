<script>
    const body = document.body;
    const darkToggle = document.getElementById("darkModeToggle");
    const sidebar = document.getElementById("sidebar");
    const toggleSidebarBtn = document.getElementById("toggleSidebar");

    if (localStorage.getItem("darkMode") === "enabled") {
        body.classList.add("dark-mode");
    }

    darkToggle.addEventListener("click", () => {
        body.classList.toggle("dark-mode");
        localStorage.setItem("darkMode", body.classList.contains("dark-mode") ? "enabled" : "disabled");
    });

    toggleSidebarBtn.addEventListener("click", () => {
        sidebar.classList.toggle("visible");
    });

    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            document.getElementById("userName").textContent = user.displayName || "User";
            document.getElementById("userEmail").textContent = user.email;

            // Check Firestore for existing phone number
            const userDoc = await db.collection("users").doc(user.uid).get();
            const userData = userDoc.data();

            if (!user.phoneNumber && (!userData || !userData.phoneNumber)) {
                const phone = prompt("Please enter your phone number (required):");
                if (phone) {
                    db.collection("users").doc(user.uid).set({
                        phoneNumber: phone,
                        email: user.email,
                        name: user.displayName || "User"
                    }, { merge: true }).then(() => {
                        alert("✅ Phone number saved successfully.");
                    }).catch(error => {
                        console.error("❌ Error saving phone:", error);
                        alert("❌ Failed to save phone number.");
                    });
                } else {
                    alert("⚠️ Phone number is required to continue.");
                }
            }
        } else {
            alert("Please sign in to use the dashboard.");
            window.location.href = "/login.html";
        }
    });

    const navLinks = document.querySelectorAll(".sidebar a");
    const sections = document.querySelectorAll(".main-content section");

    navLinks.forEach(link => {
        link.addEventListener("click", (e) => {
            e.preventDefault();
            const target = link.textContent.trim().toLowerCase() + "Section";
            sections.forEach(section => {
                section.style.display = section.id === target ? "block" : "none";
            });

            if (target === "coursesSection") loadCourses();
            if (target === "enrolledSection") loadEnrolledCourses();
        });
    });

    function loadCourses() {
        const container = document.getElementById("coursesList");
        const searchInput = document.getElementById("courseSearch");

        db.collection("courses").onSnapshot(snapshot => {
            let courses = [];
            snapshot.forEach(doc => {
                courses.push({ id: doc.id, ...doc.data() });
            });

            function renderCourses(filter = "") {
                let html = "";
                const filtered = courses.filter(c => c.title.toLowerCase().includes(filter.toLowerCase()));
                if (filtered.length === 0) {
                    html = "<p>No courses found.</p>";
                } else {
                    filtered.forEach(course => {
                        html += `
                            <div class="course-card">
                                <h5>${course.title}</h5>
                                <p>${course.description}</p>
                                <button class="btn btn-primary btn-sm btn-enroll"
                                    onclick="requestEnrollment('${course.id}', '${course.title}')">
                                    Request Enroll
                                </button>
                            </div>
                        `;
                    });
                }
                container.innerHTML = html;
            }

            renderCourses();
            searchInput.addEventListener("input", () => {
                renderCourses(searchInput.value);
            });
        });
    }

    function requestEnrollment(courseId, courseTitle) {
        const user = firebase.auth().currentUser;
        if (!user) {
            alert("Please log in first.");
            return;
        }

        const requestRef = db.collection("course_requests");

        requestRef.add({
            userId: user.uid,
            courseId: courseId,
            status: "pending",
            requestedAt: new Date()
        }).then(() => {
            alert(`Enrollment request sent for: ${courseTitle}`);
        }).catch(error => {
            console.error("Enrollment request error:", error);
            alert("Failed to send request. Try again.");
        });
    }

    function loadEnrolledCourses() {
        const container = document.getElementById("enrolledCoursesContainer");
        const user = firebase.auth().currentUser;
        if (!user) return;

        db.collection("course_requests")
            .where("userId", "==", user.uid)
            .where("status", "==", "approved")
            .get()
            .then(snapshot => {
                if (snapshot.empty) {
                    container.innerHTML = "<p>No enrolled courses.</p>";
                    return;
                }

                let html = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    db.collection("courses").doc(data.courseId).get().then(courseDoc => {
                        const course = courseDoc.data();
                        html += `
                            <div class="course-card">
                                <h5>${course.title}</h5>
                                <p>${course.description}</p>
                                <a class="btn btn-success btn-sm" href="${course.link}" target="_blank">Go to Course</a>
                            </div>
                        `;
                        container.innerHTML = html;
                    });
                });
            });
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
        firebase.auth().signOut().then(() => {
            window.location.href = "/login.html";
        });
    });
</script>
